<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Admin Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
        
        <style>
            
            /* --- General & Body Styles --- */
            body {
                font-family: 'Poppins', sans-serif;
                margin: 0;
                background-color: #f4f7fa;
                color: #333;
            }
            .main-container {
                display: flex;
            }

            /* --- Sidebar Styles --- */
            .sidebar {
                width: 280px;
                background-color: #14532d;
                color: #ffffff;
                height: 100vh;
                padding: 20px;
                box-sizing: border-box;
                position: fixed;
                top: 0;
                left: 0;
                overflow-y: auto;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            .sidebar::-webkit-scrollbar {
                display: none;
            }
            .sidebar h2 {
                text-align: center;
                margin-top: 10px;
                margin-bottom: 30px;
                font-size: 22px;
            }
            .sidebar ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .sidebar ul h3 {
                color: #ffff;
                font-size: 18px;
                margin-top: 20px;
                margin-bottom: 10px;
                padding-left: 10px;
            }
            .sidebar ul li a {
                display: block;
                color: #e0e0e0;
                text-decoration: none;
                padding: 12px 15px;
                border-radius: 8px;
                transition: background-color 0.3s, color 0.3s;
                font-weight: 500;
            }
            .sidebar ul li a:hover, .sidebar ul li a.active {
                background-color: #ffffff;
                color: #111827;
            }

            /* --- Main Content Styles --- */
            .main-content {
                flex-grow: 1;
                margin-left: 280px; /* Same as sidebar width */
                padding: 20px;
                transition: all 0.3s ease-in-out
            }
            body.sidebar-closed .sidebar {
                width: 0;
                padding-left: 0;
                padding-right: 0;
                overflow: hidden;
            }
            body.sidebar-closed .main-content {
                margin-left: 0;
            }

            /* --- Header & Navigation --- */
            .header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px 30px;
                background-color: #ffffff;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
                margin-bottom: 30px;
            }
            .header-left {
                display: flex;
                align-items: center;
                gap: 15px;
            }
            #sidebar-toggle {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
            }
            #sidebar-toggle span {
                display: block;
                width: 22px;
                height: 3px;
                background-color: #333;
                margin: 4px 0;
                border-radius: 2px;
            }
            .header h1 {
                font-size: 24px;
                font-weight: 600;
                color: #011805;
                margin: 0;
            }
            .header-right { display: flex; align-items: center; gap: 20px; }
            .header-right .admin-name { font-weight: 500; color: #555; }
            .logout-btn {
                background-color: #e74c3c;
                color: white;
                padding: 8px 16px;
                border-radius: 8px;
                text-decoration: none;
                font-weight: 500;
                transition: background-color 0.3s ease, transform 0.2s ease;
            }
            .logout-btn:hover {
                background-color: #c0392b;
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
            }

            /* --- Summary & Filters --- */
            .summary-row { display: flex; justify-content: center; gap: 25px; margin-bottom: 35px; flex-wrap: wrap; }
            .summary-card { flex: 1; min-width: 250px; padding: 25px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
            .summary-card:hover { transform: translateY(-5px); }
            .summary-card h2 { font-size: 18px; margin-top: 0; margin-bottom: 10px; font-weight: 500; }
            .summary-card p { font-size: 32px; font-weight: 700; margin: 0; }
            .summary-card.purple { background: linear-gradient(45deg, #046720, #027623); }
            .summary-card.dark { background: linear-gradient(45deg, #00c13d, #0c8f00); }
            .summary-card.light { background: linear-gradient(45deg, #0c2e02, #030c06); }
            .filters { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); }
            .filters label { font-weight: 500; color: #333; display: flex; align-items: center; gap: 8px; }
            .filters select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background-color: #f9f9f9; font-family: 'Poppins', sans-serif; font-size: 14px; }
            .filters button { padding: 8px 20px; border-radius: 8px; border: none; background-color: #14532d; color: white; cursor: pointer; font-weight: 500; transition: background-color 0.3s ease; }
            .filters button:hover { background-color: #1f950a; }
            
            /* --- Chart Cards --- */
            .chart-container {
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .card {
                background: #fff;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
                width: 100%;
                max-width: 900px; /* Control max width for better viewing */
            }
            canvas {
                width: 100% !important;
                height: 450px !important;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="main-container">
            <nav class="sidebar">
                <h2>Dashboard Menu</h2>
                <ul>
                    <h3>Demographics</h3>
                    <li><a href="#" class="nav-link" data-target="courseChartCard">Distribution by Course</a></li>
                    <li><a href="#" class="nav-link" data-target="genderChartCard">Distribution by Gender</a></li>
                    <li><a href="#" class="nav-link" data-target="ageChartCard">Distribution by Age group</a></li>
                    <li><a href="#" class="nav-link" data-target="riskChartCard">Composite Risk Breakdown</a></li>
                    <li><a href="#" class="nav-link" data-target="districtChartCard">Distribution by District</a></li>
                    <li><a href="#" class="nav-link" data-target="collegeChartCard">Distribution by College</a></li>
                    <li><a href="#" class="nav-link" data-target="yearStudyChartCard">Distribution by Year of Study</a></li>
                    
                    <h3>Mental Health Scores</h3>
                    <li><a href="#" class="nav-link" data-target="phqChartCard">PHQ-9</a></li>
                    <li><a href="#" class="nav-link" data-target="gadChartCard">GAD-7</a></li>
                    <li><a href="#" class="nav-link" data-target="ghqChartCard">GHQ-12</a></li>

                    <h3>Correlation  and Insights</h3>
                    <li><a href="#" class="nav-link" data-target="phqVsGadScatterCard">PHQ VS GAD</a></li>
                    <li><a href="#" class="nav-link" data-target="gadVsGhqScatterCard">GAD VS GHQ</a></li>
                    <li><a href="#" class="nav-link" data-target="phqVsGhqScatterCard">PHQ VS GHQ</a></li>
                </ul>
            </nav>

            <main class="main-content">
                <div class="header">
                    <div class="header-left">
                        <button id="sidebar-toggle" title="Toggle Sidebar">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                    <h1>Student Analytics Overview</h1>
                    </div>
                    <div class="header-right">
                        <span class="admin-name">Admin</span>
                        <a href="{{ url_for('admin_logout') }}" class="logout-btn">Logout</a>
                    </div>
                </div>

                <div class="summary-row">
                    <div class="summary-card purple"><h2>Total Users</h2><p>{{ total_users }}</p></div>
                    <div class="summary-card dark"><h2>Active Users</h2><p>{{ active_users }}</p></div>
                    <div class="summary-card light"><h2>High Risk Users</h2><p>{{ high_risk_users }}</p></div>
                </div>

                <form method="get" class="filters">
                    <label>District:
                        <select name="district">
                            <option value="All" {% if selected_district == 'All' %}selected{% endif %}>All</option>
                            {% for d in districts %}<option value="{{ d }}" {% if selected_district == d %}selected{% endif %}>{{ d }}</option>{% endfor %}
                        </select>
                    </label>
                    <label>Gender:
                        <select name="gender">
                            <option value="All" {% if selected_gender == 'All' %}selected{% endif %}>All</option>
                            {% for g in genders %}<option value="{{ g }}" {% if selected_gender == g %}selected{% endif %}>{{ g }}</option>{% endfor %}
                        </select>
                    </label>
                    <label>Age Group:
                        <select name="age_group">
                            <option value="All" {% if selected_age == 'All' %}selected{% endif %}>All</option>
                            {% for a in ages %}<option value="{{ a }}" {% if selected_age == a %}selected{% endif %}>{{ a }}</option>{% endfor %}
                        </select>
                    </label>
                    <button type="submit">Apply</button>
                </form>

                <div class="chart-container">
                    <div class="card chart-card hidden" id="courseChartCard"><canvas id="courseChart"></canvas></div>
                    <div class="card chart-card hidden" id="genderChartCard"><canvas id="genderChart"></canvas></div>
                    <div class="card chart-card hidden" id="riskChartCard"><canvas id="riskChart"></canvas></div>
                    <div class="card chart-card hidden" id="ageChartCard"><canvas id="ageChart"></canvas></div>
                    <div class="card chart-card hidden" id="districtChartCard"><canvas id="districtChart"></canvas></div>
                    <div class="card chart-card hidden" id="collegeChartCard"><canvas id="collegeChart"></canvas></div>
                    <div class="card chart-card hidden" id="yearStudyChartCard"><canvas id="yearStudyChart"></canvas></div>
                    <div class="card chart-card hidden" id="phqChartCard"><canvas id="phqChart"></canvas></div>
                    <div class="card chart-card hidden" id="gadChartCard"><canvas id="gadChart"></canvas></div>
                    <div class="card chart-card hidden" id="ghqChartCard"><canvas id="ghqChart"></canvas></div>
                    <div class="card chart-card hidden" id="phqVsGadScatterCard"><canvas id="phqVsGadScatter"></canvas></div>
                    <div class="card chart-card hidden" id="gadVsGhqScatterCard"><canvas id="gadVsGhqScatter"></canvas></div>
                    <div class="card chart-card hidden" id="phqVsGhqScatterCard"><canvas id="phqVsGhqScatter"></canvas></div>
                </div>
            </main>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // --- Parse Data from Flask ---
                // Ensure data exists before trying to access nested properties
                const rawData = '{{ data_json | safe }}';
                const data = rawData ? JSON.parse(rawData) : {};
                
                Chart.defaults.global.defaultFontFamily = "'Poppins', sans-serif";
                
                // --- Sidebar Navigation Logic ---
                const navLinks = document.querySelectorAll('.nav-link');
                const chartCards = document.querySelectorAll('.chart-card');

                function showChart(targetId) {
                    chartCards.forEach(card => card.classList.add('hidden'));
                    navLinks.forEach(link => link.classList.remove('active'));
                    const targetCard = document.getElementById(targetId);
                    if (targetCard) targetCard.classList.remove('hidden');
                    const activeLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }

                navLinks.forEach(link => {
                    link.addEventListener('click', function(event) {
                        event.preventDefault();
                        showChart(this.getAttribute('data-target'));
                    });
                });

                // --- Sidebar Toggling Logic ---
                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-closed');
                });
                
                // --- Guard clause to prevent errors if data is missing ---
                if (!data.demographics || !data.mental_health || !data.scatter_plots) {
                    console.error("Chart data is missing or incomplete. Check the data source.");
                    return; 
                }

                // --- All CHART INITIALIZATION CODE ---
                
                // Demographics
                new Chart(document.getElementById('courseChart').getContext('2d'), { type: 'bar', data: { labels: data.demographics.courses.labels, datasets: [{ label: 'Distribution by Course', data: data.demographics.courses.values, backgroundColor: '#6b5ac7' }] }, options: { responsive: true, title: { display: true, text: 'Distribution by Course', fontSize: 16 }, scales: { yAxes: [{ ticks: { beginAtZero: true } }] } } });
                new Chart(document.getElementById('genderChart').getContext('2d'), { type: 'pie', data: { labels: data.demographics.genders.labels, datasets: [{ label: 'Gender Distribution', data: data.demographics.genders.values, backgroundColor: ['#2a2c74', '#6b5ac7', '#a192f7', '#00C49A', '#FFBB28'] }] }, options: { responsive: true, maintainAspectRatio: false, title: { display: true, text: 'Gender Distribution', fontSize: 16 } } });
                new Chart(document.getElementById('riskChart').getContext('2d'), { type: 'bar', data: { labels: data.demographics.risks.labels, datasets: [{ label: 'Composite Risk Breakdown', data: data.demographics.risks.values, backgroundColor: '#2a2c74' }] }, options: { responsive: true, title: { display: true, text: 'Composite Risk Breakdown', fontSize: 16 }, scales: { yAxes: [{ ticks: { beginAtZero: true } }] } } });
                new Chart(document.getElementById('ageChart').getContext('2d'), { type: 'bar', data: { labels: data.demographics.ages.labels, datasets: [{ label: 'Age Group Distribution', data: data.demographics.ages.values, backgroundColor: '#a192f7' }] }, options: { responsive: true, title: { display: true, text: 'Age Group Distribution', fontSize: 16 }, scales: { yAxes: [{ ticks: { beginAtZero: true } }] } } });
                new Chart(document.getElementById('districtChart').getContext('2d'), { type: 'pie', data: { labels: data.demographics.districts.labels, datasets: [{ label: 'District-wise Distribution', data: data.demographics.districts.values, backgroundColor: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'] }] }, options: { responsive: true, maintainAspectRatio: false, title: { display: true, text: 'District-wise Distribution', fontSize: 16 } } });
                new Chart(document.getElementById('collegeChart').getContext('2d'), { type: 'pie', data: { labels: data.demographics.colleges.labels, datasets: [{ label: 'College Distribution', data: data.demographics.colleges.values, backgroundColor: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b'] }] }, options: { responsive: true, maintainAspectRatio: false, title: { display: true, text: 'College Distribution', fontSize: 16 } } });
                new Chart(document.getElementById('yearStudyChart').getContext('2d'), { type: 'bar', data: { labels: data.demographics.years_of_study.labels, datasets: [{ label: 'Year of Study Distribution', data: data.demographics.years_of_study.values, backgroundColor: '#00C49A' }] }, options: { responsive: true, title: { display: true, text: 'Year of Study Distribution', fontSize: 16 }, scales: { yAxes: [{ ticks: { beginAtZero: true } }] } } });
                
                // Mental Health
                new Chart(document.getElementById('phqChart').getContext('2d'), { type: 'bar', data: { labels: data.mental_health.phq.labels, datasets: [{ label: 'PHQ-9 Severity', data: data.mental_health.phq.values, backgroundColor: '#4e79a7' }] }, options: { responsive: true, title: { display: true, text: 'PHQ-9 Severity', fontSize: 16 }, scales: { yAxes: [{ scaleLabel: { display: true, labelString: 'Number of Students' }, ticks: { beginAtZero: true } }] } } });
                new Chart(document.getElementById('gadChart').getContext('2d'), { type: 'bar', data: { labels: data.mental_health.gad.labels, datasets: [{ label: 'GAD-7 Severity', data: data.mental_health.gad.values, backgroundColor: '#f28e2b' }] }, options: { responsive: true, title: { display: true, text: 'GAD-7 Severity', fontSize: 16 }, scales: { yAxes: [{ scaleLabel: { display: true, labelString: 'Number of Students' }, ticks: { beginAtZero: true } }] } } });
                new Chart(document.getElementById('ghqChart').getContext('2d'), { type: 'bar', data: { labels: data.mental_health.ghq.labels, datasets: [{ label: 'GHQ Score Distribution', data: data.mental_health.ghq.values, backgroundColor: '#76b7b2' }] }, options: { responsive: true, title: { display: true, text: 'GHQ Score Distribution', fontSize: 16 }, scales: { yAxes: [{ scaleLabel: { display: true, labelString: 'Number of Students' }, ticks: { beginAtZero: true } }] } } });
                
                // Correlations
                new Chart(document.getElementById('phqVsGadScatter').getContext('2d'), { type: 'scatter', data: { datasets: [{ label: 'PHQ vs GAD Score', data: data.scatter_plots.phq_vs_gad, backgroundColor: 'rgba(78, 121, 167, 0.8)' }] }, options: { responsive: true, title: { display: true, text: 'PHQ vs GAD Score Correlation', fontSize: 16 }, scales: { xAxes: [{ scaleLabel: { display: true, labelString: 'PHQ Score' } }], yAxes: [{ scaleLabel: { display: true, labelString: 'GAD Score' } }] } } });
                new Chart(document.getElementById('gadVsGhqScatter').getContext('2d'), { type: 'scatter', data: { datasets: [{ label: 'GAD vs GHQ Score', data: data.scatter_plots.gad_vs_ghq, backgroundColor: 'rgba(255, 99, 132, 0.8)' }] }, options: { responsive: true, title: { display: true, text: 'GAD vs GHQ Score Correlation', fontSize: 16 }, scales: { xAxes: [{ scaleLabel: { display: true, labelString: 'GAD Score' } }], yAxes: [{ scaleLabel: { display: true, labelString: 'GHQ Score' } }] } } });
                new Chart(document.getElementById('phqVsGhqScatter').getContext('2d'), { type: 'scatter', data: { datasets: [{ label: 'PHQ vs GHQ Score', data: data.scatter_plots.phq_vs_ghq, backgroundColor: 'rgba(118, 183, 178, 0.8)' }] }, options: { responsive: true, title: { display: true, text: 'PHQ vs GHQ Score Correlation', fontSize: 16 }, scales: { xAxes: [{ scaleLabel: { display: true, labelString: 'PHQ Score' } }], yAxes: [{ scaleLabel: { display: true, labelString: 'GHQ Score' } }] } } });

                // --- Show the first chart by default ---
                showChart('courseChartCard');
            });
        </script>
    </body>
</html>